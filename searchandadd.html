<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search and Add Friends</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" type="text/css" href="./stylesv1.css">
    <!-- Include your Firebase scripts here -->
</head>

<body>
    <div class="container">
        <header>
            <div>
                <span style="color: white; font-size: 16px; font-family: Nothing Font (5x7); font-weight: 400; word-wrap: break-word">Ku</span>
                <span style="color: #EEFF00; font-size: 16px; font-family: Nothing Font (5x7); font-weight: 400; word-wrap: break-word">DicK</span>
                <span style="color: white; font-size: 16px; font-family: Nothing Font (5x7); font-weight: 400; word-wrap: break-word">Ka</span>
            </div>
        </header>
        <br>
        <br>
        <br>
        <section class="friends">
            <h2>Friends</h2>
            <div id="friends"></div>
        </section>
        <section class="friend-requests">
            <h2>Friend Requests</h2>
            <div id="friendRequests"></div>
        </section>
        <br>
        <br>
        <section class="available-users">
            <h2>Available Users</h2>
            <div id="availableUsers"></div>
        </section>
        <br>
        <br>

    </div>

    <script>
    var firebaseConfig = {
            apiKey: "AIzaSyCZfnZbZIKR1zyywjrXJu0MJOjETO35aTE",
            authDomain: "split-bill-6c19e.firebaseapp.com",
            databaseURL: "https://split-bill-6c19e-default-rtdb.firebaseio.com",
            projectId: "split-bill-6c19e",
            storageBucket: "split-bill-6c19e.appspot.com",
            messagingSenderId: "297198677510",
            appId: "1:297198677510:web:9cec9889c3224da9735d87"
          };

    firebase.initializeApp(firebaseConfig);

    var currentUserId;

    window.onload = function() {
        const auth = firebase.auth();
        auth.onAuthStateChanged(user => {
            if (user) {
                userId = user.uid;
                loadFriendRequests(userId);
                loadAvailableUsers(userId);
            } else {
                // Handle user not signed in
            }
        });
    };

    function sendFriendRequest(friendId, friendName, friendPhoneNumber, currentUserId) {
    const senderFriendRequestRef = firebase.database().ref(`users/${userId}/friendRequests/${friendId}`);
    const receiverFriendRequestRef = firebase.database().ref(`users/${userId}/friendRequests/${currentUserId}`);

    // Add friend request to sender's friendRequests with pending status
    senderFriendRequestRef.set({
        senderId: currentUserId,
        senderName: 'Sender Name', // Replace with sender's name
        senderPhoneNumber: friendPhoneNumber, // Pass the correct sender's phone number here
        status: 'pending'
    });

    // Add friend request to receiver's friendRequests with pending status
    receiverFriendRequestRef.set({
        senderId: currentUserId,
        senderName: 'Sender Name', // Replace with sender's name
        senderPhoneNumber: friendPhoneNumber, // Pass the correct sender's phone number here
        status: 'pending'
    });

    console.log(`Friend request sent to UID: ${friendId}, Name: ${friendName}, Phone Number: ${friendPhoneNumber}`);
}



        // Confirm friend request
        function confirmFriendRequest(currentUserId, friendId) {
            // Update status to accepted in the sender's friend requests
            firebase.database().ref(`users/${currentUserId}/friendRequests/${friendId}`).update({
                status: 'accepted'
            });

            // Update status to accepted in the receiver's friend requests
            firebase.database().ref(`users/${friendId}/friendRequests/${currentUserId}`).update({
                status: 'accepted'
            });

            // Move friend from sender's pendingFriends to friends list
            const friendDetails = {
                name: 'Friend Name', // Replace with friend's name
                phoneNumber: 'Friend Phone Number' // Replace with friend's phone number
            };
            firebase.database().ref(`users/${currentUserId}/friends/${friendId}`).set(friendDetails);

            // Move friend from receiver's pendingFriends to friends list
            const senderDetails = {
                name: 'Sender Name', // Replace with sender's name
                phoneNumber: 'Sender Phone Number' // Replace with sender's phone number
            };
            firebase.database().ref(`users/${friendId}/friends/${currentUserId}`).set(senderDetails);
        }

    function loadFriendRequests(currentUserId) {
        const friendRequestsRef = firebase.database().ref(`users/${currentUserId}/friendRequests`);
        friendRequestsRef.on('value', snapshot => {
            const friendRequests = snapshot.val();
            const friendRequestsDiv = document.getElementById('friendRequests');
            friendRequestsDiv.innerHTML = '';
            if (friendRequests) {
                Object.keys(friendRequests).forEach(key => {
                    const request = friendRequests[key];
                    if (request.status === 'pending') {
                        const requestElement = document.createElement('div');
                        requestElement.className = 'request-box';
                        requestElement.innerHTML = `
                            <div>Sender ID: ${request.senderId}</div>
                            <div>Sender Name: ${request.senderName}</div>
                            <div>Sender Phone Number: ${request.senderPhoneNumber}</div>
                            <button class="confirm-btn" onclick="confirmFriendRequest('${key}', '${request.senderId}', '${currentUserId}')">Confirm</button>
                        `;
                        friendRequestsDiv.appendChild(requestElement);
                    }
                });
            } else {
                friendRequestsDiv.textContent = 'No pending friend requests.';
            }
        });
    }

// Load available users and display them in the availableUsersDiv
function loadAvailableUsers(currentUserId) {
    const usersRef = firebase.database().ref('users');
    usersRef.on('value', snapshot => {
        const users = snapshot.val();
        const availableUsersDiv = document.getElementById('availableUsers');
        const friendsDiv = document.getElementById('friends');
        const friendRequestsDiv = document.getElementById('friendRequests');

        // Clear previous content
        availableUsersDiv.innerHTML = '';
        friendsDiv.innerHTML = '';
        friendRequestsDiv.innerHTML = '';

        if (users) {
            Object.keys(users).forEach(key => {
                if (key !== currentUserId) {
                    const user = users[key].details;
                    const status = users[currentUserId].friendRequests && users[currentUserId].friendRequests[key] ? users[currentUserId].friendRequests[key].status : null;

                    if (status === 'pending') {
                        // Display user data in friend requests section
                        const friendRequestElement = document.createElement('div');
                        friendRequestElement.className = 'user-box';
                        friendRequestElement.innerHTML = `
                            <div>UID: ${key.slice(-4)}</div>
                            <div>Name: ${user.name}</div>
                            <div>Phone Number: ${user.phoneNumber}</div>
                            <button class="confirm-btn" id="confirmButton-${key}">Confirm</button>
                        `;
                        friendRequestsDiv.appendChild(friendRequestElement);

                        const confirmButton = document.getElementById(`confirmButton-${key}`);
                        confirmButton.addEventListener('click', () => confirmFriendRequest(currentUserId, key));
                    } else if (status === 'accepted') {
                        // Display user data in friends section
                        const friendElement = document.createElement('div');
                        friendElement.className = 'user-box';
                        friendElement.innerHTML = `
                            <div>UID: ${key.slice(-4)}</div>
                            <div>Name: ${user.name}</div>
                            <div>Phone Number: ${user.phoneNumber}</div>
                        `;
                        friendsDiv.appendChild(friendElement);
                    } else if (status === null) {
                        // Display user data in available users section
                        const userElement = document.createElement('div');
                        userElement.className = 'user-box';
                        userElement.innerHTML = `
                            <div>UID: ${key.slice(-4)}</div>
                            <div>Name: ${user.name}</div>
                            <div>Phone Number: ${user.phoneNumber}</div>
                            <button class="add-friend-btn" id="addFriendButton-${key}">Add Friend</button>
                        `;
                        availableUsersDiv.appendChild(userElement);

                        const addButton = document.getElementById(`addFriendButton-${key}`);
                        addButton.addEventListener('click', () => sendFriendRequest(currentUserId, key, user.name, user.phoneNumber));
                    }
                }
            });
        }

        // Hide friend requests section if there are no friend requests
        if (friendRequestsDiv.children.length === 0) {
            friendRequestsDiv.style.display = 'none';
        } else {
            friendRequestsDiv.style.display = 'block';
        }
    });
}




// Confirm friend request
function confirmFriendRequest(currentUserId, friendId) {
    // Update status to accepted in the sender's friend requests
    firebase.database().ref(`users/${currentUserId}/friendRequests/${friendId}`).update({
        status: 'accepted'
    });

    // Update status to accepted in the receiver's friend requests
    firebase.database().ref(`users/${friendId}/friendRequests/${currentUserId}`).update({
        status: 'accepted'
    });

    // Move friend from sender's pendingFriends to friends list
    const friendDetails = {
        name: users[friendId].details.name,
        phoneNumber: users[friendId].details.phoneNumber
    };
    firebase.database().ref(`users/${currentUserId}/friends/${friendId}`).set(friendDetails);

    // Move friend from receiver's pendingFriends to friends list
    const senderDetails = {
        name: users[currentUserId].details.name,
        phoneNumber: users[currentUserId].details.phoneNumber
    };
    firebase.database().ref(`users/${friendId}/friends/${currentUserId}`).set(senderDetails);
}


    </script>
</body>

</html>
