<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" type="text/css" href="./stylesv1.css"> 
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" crossorigin="anonymous">
    <title>Expense Calculator Dashboard</title>
</head>
<body>
    
    <div class="container">
 <span id="user-id"></span>

        <header>
            <div><span style="color: white; font-size: 16px; font-family: Nothing Font (5x7); font-weight: 400; word-wrap: break-word">Ku</span><span style="color: #EEFF00; font-size: 16px; font-family: Nothing Font (5x7); font-weight: 400; word-wrap: break-word">DicK</span><span style="color: white; font-size: 16px; font-family: Nothing Font (5x7); font-weight: 400; word-wrap: break-word">Ka</span></div>            <button id="logoutButton1">Logout </button>
            <div id="success-message" class="message" style="display: none;"></div>
        </header>
        <br>
        <br>
        <br>
        <section class="kpi-container">
            <div class="kpi-box expense" id="expense-section" style="display: none;">
                <h3> Expense</h3>
                <p id="expense-amount" class="currency-inr">₹ 0.00</p>
            </div>
            
            <div class="kpi-box income" id="income-section" style="display: none;">
                <h3> Income</h3>
                <p id="income-amount" class="currency-inr">₹ 0.00</p>
            </div>
            
            <div class="kpi-box balance" id="balance-section">
                <h3> Balance</h3>
                <p id="balance-amount" class="currency-inr">₹ 0.00</p>
    
<button class="arrow-button" id="balance-button">
    <svg viewBox="0 0 320 512" height="1em" xmlns="http://www.w3.org/2000/svg" class="chevron-right">
    <path d="M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"></path>
</svg>
</button>
<button class="arrow-button" id="expense-button">
<svg viewBox="0 0 320 512" height="1em" xmlns="http://www.w3.org/2000/svg" class="chevron-right">
    <path d="M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"></path>
</svg>
</button>
<button class="arrow-button" id="income-button">
<svg viewBox="0 0 320 512" height="1em" xmlns="http://www.w3.org/2000/svg" class="chevron-right">
    <path d="M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"></path>
</svg>
</button> 

  </div>
            </div>            
            </div>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
        </section>
        <section class="history">
            <h3>Latest transactions:</h3>
            <div class="history-entries-container" id="history-entries-container">
                <div id="history-table-body"></div>

                <!-- Transaction entries will be dynamically added here -->
            </div>
        </section>
    </div>
    

    <!-- Navbar codes -->

    <div class="navbar">
        <a href="#home" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="/dashboard.html" class="nav-item"><i class="fas fa-exchange-alt"></i><span>Transaction</span></a>
        <div class="nav-item nav-center">
            <a href="/search.html" class="nav-center-btn"><i class="fas fa-plus"></i></a>
        </div>
        <a href="#" class="nav-item"><i class="fas fa-chart-pie"></i><span>Report</span></a>
        <a href="./profile.html" class="nav-item"><i class="fas fa-user"></i><span>Profile</span></a>
    </div>
    
<!-- Logout Confirmation Popup -->
<div class="popup" id="logoutPopup">
    <div class="popup-content1">
        <div class="popup-title2">Do you want to logout?</div>
        <div><span style="color: white; font-size: 10px; font-family: Montserrat; font-weight: 600; word-wrap: break-word">This will log you out from </span><span style="color: white; font-size: 10px; font-family: Montserrat; font-weight: 500; word-wrap: break-word"> </span><span style="color: white; font-size: 10px; font-family: Nothing Font (5x7); font-weight: 400; word-wrap: break-word">Ku</span><span style="color: #EEFF00; font-size: 10px; font-family: Nothing Font (5x7); font-weight: 400; word-wrap: break-word">DicK</span><span style="color: white; font-size: 10px; font-family: Nothing Font (5x7); font-weight: 400; word-wrap: break-word">Ka</span></div>        <div class="popup-buttons">
            <br>
            <button id="cancelButton">Cancel</button>
            <button id="confirmButton">Confirm</button>
        </div>
    </div>
</div>

</body>
<script>
    document.addEventListener('DOMContentLoaded', function() {

    // Define the transactions variable at a higher scope
const transactions = [];

// Initialize Firebase (if not already initialized)
var firebaseConfig = {
    apiKey: "AIzaSyCZfnZbZIKR1zyywjrXJu0MJOjETO35aTE",
  authDomain: "split-bill-6c19e.firebaseapp.com",
  databaseURL: "https://split-bill-6c19e-default-rtdb.firebaseio.com",
  projectId: "split-bill-6c19e",
  storageBucket: "split-bill-6c19e.appspot.com",
  messagingSenderId: "297198677510",
  appId: "1:297198677510:web:9cec9889c3224da9735d87"
};
    firebase.initializeApp(firebaseConfig);

// Reference to the Firebase database
const database = firebase.database();

// Get the authenticated user's ID
let authUserId;
firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    authUserId = user.uid;
    displayLatestTransactions();
  }
});

// Function to display the latest transactions
function displayLatestTransactions() {
  // Reference to the user's transaction history
  const userTransactionsRef = database.ref(`users/${authUserId}/transactions`);

  // Get the latest transactions (limit to, for example, 5)
  userTransactionsRef.orderByChild('timestamp').limitToLast(5).once('value')
    .then((snapshot) => {
      const historyTableBody = document.getElementById('history-table-body');
      historyTableBody.innerHTML = ''; // Clear existing entries

      snapshot.forEach((transactionSnapshot) => {
        const transactionData = transactionSnapshot.val();

        // Get the friend's name who paid
        const whoPaidUserId = transactionData.whoPaid;
        const whoPaidNamePromise = getUserName(whoPaidUserId);

        whoPaidNamePromise.then((whoPaidName) => {
          const date = new Date(transactionData.timestamp);
          const formattedDate = formatDate(date);
          const formattedTime = formatTime(date);

          // Calculate if the user owes or is owed
          const isOwe = authUserId === whoPaidUserId;
          const amountText = isOwe ? `You owe: ₹${transactionData.amount}` : `You are owed: ₹${transactionData.amount}`;

          // Determine text color (red for owe, green for owed)
          const textColor = isOwe ? 'red' : 'green';

          // Create HTML elements for each transaction entry
          const transactionEntry = document.createElement('div');
          transactionEntry.classList.add('history-entry');

          transactionEntry.innerHTML = `
            <p><strong></strong> ${formattedDate}</p>
            <p><strong></strong> ${formattedTime}</p>
            <p><strong>Split with:</strong> ${whoPaidName}</p>
            <p style="color: ${textColor};"><strong>${amountText}</strong></p>
          `;

          // Add click event to show detailed transaction information
          transactionEntry.addEventListener('click', () => {
            showDetailedTransaction(transactionData, whoPaidName);
          });

          // Append the transaction entry to the history table body
          historyTableBody.appendChild(transactionEntry);
        });
      });
    })
    .catch((error) => {
      console.error('Error fetching transactions:', error);
    });
}

// Function to get the user's name from the user's ID
function getUserName(userId) {
  return database.ref(`users/${userId}/details/name`).once('value')
    .then((snapshot) => snapshot.val())
    .catch((error) => {
      console.error('Error fetching user name:', error);
      return 'Unknown';
    });
}

// Function to show detailed transaction information
function showDetailedTransaction(transactionData, whoPaidName) {
  // Placeholder - customize this function to display detailed transaction information
  console.log('Detailed transaction information:', transactionData, whoPaidName);
  // You can use a modal or update another section of your page to display details
}

// Function to format date (e.g., 16 Nov '23)
function formatDate(date) {
  const options = { day: 'numeric', month: 'short', year: '2-digit' };
  return new Intl.DateTimeFormat('en-US', options).format(date);
}

// Function to format time (e.g., 2:00 PM)
function formatTime(date) {
  const options = { hour: 'numeric', minute: 'numeric', hour12: true };
  return new Intl.DateTimeFormat('en-US', options).format(date);
}



// Get the logout button and the popup elements
const logoutButton = document.getElementById('logoutButton1'); // Updated ID
const logoutPopup = document.getElementById('logoutPopup');
const cancelButton = document.getElementById('cancelButton');
const confirmButton = document.getElementById('confirmButton');

// Add click event listener to the logout button
logoutButton.addEventListener('click', function() {
    logoutPopup.style.display = 'flex'; // Show the popup
});

// Add click event listeners to the popup buttons
cancelButton.addEventListener('click', function() {
    logoutPopup.style.display = 'none'; // Hide the popup on cancel
});

confirmButton.addEventListener('click', function() {
    logout(); // Call the logout function on confirm
    logoutPopup.style.display = 'none'; // Hide the popup after logout
});
    // Function to log out the user
    function logout() {
        try {
            firebase.auth().signOut().then(function() {
                // Sign-out successful, redirect to the login page
                window.location.href = '../index.html';
            }).catch(function(error) {
                // Handle sign-out error
                console.error('Logout error:', error);
            });
        } catch (error) {
            console.error('Logout error (try-catch):', error);
        }
    }

// Function to handle the click event of the "+" sign
const addButton = document.getElementById('addButton');
    // Show the popup when the "+" sign is clicked
    addButton.addEventListener('click', function() {
        window.location.href = './search.html';

});
    });




</script>
</html>